# 🔬 OpenFE minimal FEP workflow on AWS

This is an educational example to illustrate a **minimal Free-Energy Perturbation (FEP)** campaign with
[OpenFE](https://github.com/OpenFreeEnergy/openfe) running on the cloud (AWS).  

We will try to rank five ligands bound to T4 lysozyme L99A (PDB ID: 4W52). It completed within a few hours on an 8-GPU AWS instance (g5.48xlarge).

The repo provides scripts, environment setup, and workflows to prep, execute, and analyze FEP runs.

---

## 📁 What’s Inside

| Folder | Purpose |
|--------|---------|
| [prep/](prep)         | Ligand & system prep scripts (e.g., parmetrize ligands with ML, clean pdb) |
| [run/](run)           | AWS batch scripts, job configs, launch helpers |
| [example/](example) | Toy dataset (small protein + ligands) to test |

---

# 🧪 Toy System: L99A Lysozyme + 5 aryls

- **Protein**: T4 Lysozyme L99A (cavity mutant, 4W52)
- **Ligands**: Benzene → Toluene → Phenol → Aniline → Isopropylbenzene

<p align="center">
  <img src="/images/FEP.png" width="600">

Below are the ligands, with their experimental binding affinities: 
<p align="center">
  <img src="/images/fep_overview.png" width="600">

---

## 📂 List of files

| File | Description |
|------|-------------|
| `protein.pdb` | Input, raw structure from PDB |
| `cleaned_protein.pdb` | Cleaned structure after `clean_protein.py` |
| `lig_A.sdf … lig_E.sdf` | Ligand files, can be built from smiles via `generate_ligand.py` |
| `ligands.sdf` | Input, ligands docked and merged into a single file |
| `charged_ligands.sdf` | Ligands with ML (Espaloma) partial charges |
| `update_json_params.py` | Editable script to change default repeats and simulations lenght |
| `run.sh` | Allocates different jobs to different available GPUs |
| `check_completion.py` | Output information on completed and pending jobs |
| `charged_ligands.sdf` | Ligands with ML (Espaloma) partial charges |
| `transformations.json` | Example of input file generated by OpenFE |
| `ligand_network.graphml` | Default network generated by OpenFE |
| `easy_rbfe_lig_A_solvent_lig_C_solvent_gpu3.json` | Output example for one alchemical transformation |
| `ddg.out` | Output example with relative free energies between compounds |

---

## 🚀 Quick Start

Clone the repo and create your environment:

```bash
# 0) clone 
git clone https://github.com/dbucher1234/openfe-fep-aws.git
cd openfe-fep-aws

# 1) prep ligands (optional: use ML partial charges instead of AM1/BCC to save time)
conda env create -f espaloma_env.yml
conda activate esp
cd prep
python esp_neutral.py ligands.sdf 

# 2) prep protein (pdbfix if needed)
conda env create -f openfe_env.yml
conda activate openfe
python clean_protein.py

# 3) login to AWS
aws ec2 start-instances --instance-ids *AWS-ID-HERE*
# login by ssh, send by scp: ligands.sdf, protein.pdb + /run

# 4) On AWS
# install OpenFE and its environement, and then:
openfe plan-rbfe-network -M ligands.sdf -p cleaned_protein.pdb -o network_setup/transformations
# will create a default network.
# For 5 ligands, it creates 8 transformations (4 in solvent + 4 in complex), which is trivial to parallelize on 8 GPUs. 
# python update_json_params.py can be used for testing & debugging.
# It changes the repeats from n=3 to n=1, and the lenght of each simulation from 5ns to 2ns.

# Solvent calculations take about 30min on 1 GPU, and complex calculations about 6h. To run:
nohup ./run.sh > run.log 2>&1 &  # running in the background to remain stable if the shell closes.
python check_completion.py  # provide info about running and completed calculations.
# resubmit.py can be used to resubmit only jobs that did not complete.

# 5) Gathering results
# if running a full calculations (3 repeats per leg): openfe gather --report dG
# if running a partial calculation (1 repeat):
openfe gather --allow-partial --report ddg . > ddg.out &
# write a script to rank compound from their relative free energy, or just ask ChatGPT to do it.

```
---

**Results:**

On an initial test-run, the results below were obtained for the relative free energy. No error bars are shown due to the lack of repeats (n=1 instead of n=3 by default), and limited accuracy (due to 2ns per leg instead of 5ns by default). Short simulation times are not recommended in general, but faster/cheaper to run. Setting lig_A at its free energy value to -5.16 kcal/mol, we can predict other aryls absolute binding free energies: 

<p align="center">
  <img src="/images/fep_results.png" width="600">
</p>
The predicted affinity for each compounds is the following:

<p align="center">
 <img src="/images/fep_ranking.png" width="600">
</p>

**Interpretation:**

Toluene (lig_B) is predicted to bind ~0.2 kcal mol⁻¹ more tightly than benzene (lig_A). Aniline (lig_D) is the weakest of the set by this calculation, in agreement with experiments. 

That said, none of the compounds stands out — which also aligns with experimental data. In a real drug discovery setting, you’d typically look for compounds predicted to be >1 kcal mol⁻¹ better before prioritizing synthesis. Promising hits could be confirmed before synthesis with additional sampling and repeat FEP runs.

---

## 📚 References

- Chang, C.-E.; Gilson, M. K. *J. Am. Chem. Soc.* **2007**, **129**, 943–953.  
- Boyce, S. E.; Dalby, A.; **et al.** *J. Mol. Biol.* **2009**, **394**, 747–763.  
- Morton, S. J.; Matthews, B. W. *Biochemistry* **2009**, **48**, 9466–9478. (PDB 3GUN)  
- Merski, M.; Fischer, M.; **et al.** *Proc. Natl. Acad. Sci. U.S.A.* **2015**, **112**, 5021–5026.  
- Raza, A.; Awan, H. M.; **et al.** *J. Chem. Inf. Model.* **2021**, **61**, 4599–4615.  
- **Espaloma charges:** Qiu, Y.; Smith, D. G. A.; Boothroyd, S.; Chen, J.; Chodera, J. D.  
  “Espaloma: Graph Neural Networks for Small-Molecule Force-Field Parameters.”  
  *J. Chem. Theory Comput.* **2022**, **18**, 5634–5646.  
- **OpenFE:** Young, T. J.; Unke, O. T.; Hargreaves, M.; Abraham, R. L.; et al. 
  “OpenFE: An Open-Source Framework for Alchemical Free-Energy Calculations.”  
  *J. Open Source Softw.* **2023**, **8**, 5170. 

---
